---
layout: post
title: 使用C++调用Pytorch
date: 2024-07-19
author: 曾伟
tags: [基础技能]
comments: true
toc: true # 目录
# pinned: true 是否置顶
---

简介：工作需要，需要使用C++来使用Pytorch，学无止境呀！

## 入门
在两眼一眼的情况下先问Kimi：首先，使用Pytorch进行模型训练最优的方式还是使用Python接口，简单易用，那么什么情况下需要用Pytorch的C++接口呢？—— 往往就是在模型部署推理阶段。其次，就看怎么实现模型C++部署：
1. 先将Python环境中训练好的模型文件导出为TorchScript格式，其实就是“xxx.pt"文件；
2. 安装LibTorch（PyTorch的C++分发版），使用C++版本的API函数加载模型文件和编写计算代码；
3. 写CMakeLists.txt使用CMake来进行编译管理；

## 初次尝试
1. 下载安装LibTorch
```bash
wget https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.3.1%2Bcpu.zip

unzip libtorch-cxx11-abi-shared-with-deps-2.3.1%2Bcpu.zip
```
2. 编写一个简单的C++代码测试LibTorch
```C++
// example-app.cpp

#include <torch/torch.h>
#include <iostream>
int main() {
    torch::Tensor tensor = torch::rand({2, 3});
    std::cout << tensor << std::endl;
}
```
3. 编写一个CMakeLists.txt
```CMake
cmake_minimum_required(VERSION 3.0 FATAL_ERROR)
project(example-app)

# 设置C++17标准
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 查找Torch包
find_package(Torch REQUIRED)

# 添加可执行文件
add_executable(example-app example-app.cpp)

# 链接Torch库
target_link_libraries(example-app "${TORCH_LIBRARIES}")

# 确保C++17标准被正确传递
if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    target_compile_options(example-app PRIVATE "-Wall" "-Wextra")
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    target_compile_options(example-app PRIVATE "-stdlib=libc++")
endif()

# 确保C++17标准被正确传递
set_target_properties(example-app PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)
```
4. 编译运行
```bash
mkdir build
cd build

cmake -DCMAKE_PREFIX_PATH=./libtorch ..

# 编译
make

# 运行
./example-app
```

**另外，如果已经安装了Pytorch的Python库，那么不下载LibTorch也是可以编译运行的：**
```bash
cmake -DCMAKE_PREFIX_PATH=`python3 -c 'import torch;print(torch.utils.cmake_prefix_path)'` ..
```

后知后觉，发现Pytorch[官方LibTorch下载使用文档](https://pytorch.org/cppdocs/installing.html)。

## 在ARM 64位（aarch64）设备上编译libtorch
在自己电脑跑通，但在需要运行的国产机上报错：
```bash
Scanning dependencies of target example-app
[ 50%] Building CXX object CMakeFiles/example-app.dir/example-app.cpp.o
[100%] Linking CXX executable example-app
/usr/bin/ld: ../libtorch/lib/libtorch.so: error adding symbols: file in wrong format
collect2: error: ld returned 1 exit status
make[2]: *** [CMakeFiles/example-app.dir/build.make:88：example-app] 错误 1
make[1]: *** [CMakeFiles/Makefile2:76：CMakeFiles/example-app.dir/all] 错误 2
make: *** [Makefile:84：all] 错误 2
```
使用```uname -m```才发现是ARM 64位（aarch64）的设备，